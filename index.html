<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Food Order System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; transition: all 0.3s ease; }
        .container { max-width: 90%; margin: 0 auto; padding: 2rem 1rem; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .card { background-color: #ffffff; border-radius: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); padding:2rem; margin-bottom:2rem; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color .3s ease; }
        .btn-primary { background-color: #ec4899; color: white; }
        .btn-secondary { background-color: #EFC3CA; color: white; }
        .btn-active { background-color: #ec4899; color: white; } /* pink */
        .btn-active:hover { background-color: #db2777; }
        .btn-primary:hover { background-color: #db2777; }
        .btn-secondary:hover { background-color: #db2777; }
        .hidden { display: none; }
        .table-container { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; font-size: .9rem; }
        .data-table th, .data-table td { padding: 1rem; text-align:left; border-bottom: 1px solid #e5e7eb; }
        .data-table th { background: #f9fafb; font-weight:600; color:#1f2937; cursor:pointer; }
        .data-table td { color: #4b5563; }
        .data-table tbody tr:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <div class="container bg-white p-8 rounded-2xl shadow-lg w-full max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-pink-600">Food Order System</h1>
            <p class="text-gray-500 mt-2">Manage your menus, orders, and sales report.</p>
            <p class="text-sm mt-2 text-gray-500" id="user-id-display">Loading user...</p>
        </header>

        <!-- Navigation -->
        <nav class="flex justify-center space-x-4 mb-8">
            <button id="showOrderFormBtn" class="btn btn-secondary">Place New Order</button>
            <button id="showOrdersBtn" class="btn btn-secondary">View Orders</button>
            <button id="showMenusBtn" class="btn btn-secondary">Manage Menus</button>
            <button id="showSalesReportBtn" class="btn btn-secondary">Sales Report</button>
        </nav>

        <!-- Place New Order Section -->
        <section id="orderFormSection" class="card">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Place New Order</h2>
            <form id="orderForm" class="space-y-4">
                <div>
                    <label for="customerName" class="block text-gray-700 font-medium mb-1">Customer Name</label>
                    <input type="text" id="customerName" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                </div>
                <div>
                    <label for="orderDate" class="block text-gray-700 font-medium mb-1">Order Date</label>
                    <input type="date" id="orderDate" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                </div>
                <div>
                    <label for="menuItems" class="block text-gray-700 font-medium mb-1">Menu Items</label>
                    <div id="menuItems" class="space-y-2">
                        <p class="text-gray-500 text-center" id="menu-loading-text">Loading menu...</p>
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-gray-700 font-medium mb-1">Total Price: <span id="totalPrice" class="font-bold text-orange-600">RM 0.00</span></label>
                </div>
                <button type="submit" class="w-full btn btn-primary mt-6">Submit Order</button>
            </form>
        </section>

        <!-- View Orders Section -->
        <section id="ordersListSection" class="card hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Orders List</h2>
            <p class="text-gray-500 text-center mb-4" id="orders-loading-text">Loading orders...</p>
            <div class="flex items-center space-x-2 mb-4">
                <span class="text-gray-700">Sort By:</span>
                <button onclick="sortTable('date')" class="btn btn-secondary px-3 py-1 text-sm">Date</button>
                <button onclick="sortTable('customerName')" class="btn btn-secondary px-3 py-1 text-sm">Customer</button>
            </div>
            <div class="table-container">
                <table id="ordersTable" class="data-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable('date')">Date</th>
                            <th onclick="sortTable('customerName')">Customer</th>
                            <th>Items</th>
                            <th>Total Price</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- Manage Menus Section -->
        <section id="manageMenuSection" class="card hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Manage Menus</h2>
            <p class="text-gray-500 text-center mb-4" id="menu-manage-loading-text">Loading menu...</p>
            <div id="menuList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6"></div>
            <div class="space-y-4">
                <h3 class="text-xl font-bold text-gray-800">Add New Menu Item</h3>
                <form id="menuForm" class="space-y-4">
                    <div>
                        <label for="menuName" class="block text-gray-700 font-medium mb-1">Menu Name</label>
                        <input type="text" id="menuName" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                    </div>
                    <div>
                        <label for="menuPrice" class="block text-gray-700 font-medium mb-1">Price</label>
                        <input type="number" id="menuPrice" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" step="0.01" required>
                    </div>
                    <button type="submit" class="w-full btn btn-primary">Add Menu Item</button>
                </form>
            </div>
        </section>

        <!-- Sales Report Section -->
        <section id="salesReportSection" class="card hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Sales Report</h2>
            <div class="flex items-center space-x-4 mb-4">
                <label for="reportPeriodSelect" class="text-gray-700 font-medium">Select Period:</label>
                <select id="reportPeriodSelect" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <option value="today">Today</option>
                    <option value="thisWeek">This Week</option>
                    <option value="thisMonth">This Month</option>
                </select>
            </div>
            <div id="summaryContainer" class="bg-gray-50 p-6 rounded-lg shadow-inner">
                <div class="text-center">
                    <p class="text-gray-500 text-sm">Total Sales</p>
                    <p id="totalSales" class="text-4xl font-bold text-orange-600 mt-1">RM 0.00</p>
                </div>
            </div>
            <div class="mt-8">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Top Selling Items</h3>
                <ul id="topSellingItemsList" class="space-y-2"></ul>
            </div>
        </section>

        <!-- Modal -->
        <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modalTitle"></h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500" id="modalMessage"></p>
                        <input type="text" id="modalInput" class="w-full mt-4 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 hidden"/>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="modalConfirmBtn" class="px-4 py-2 bg-orange-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-500">OK</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- SUPABASE CONFIG ---
        // IMPORTANT: Replace these with your Supabase Project URL and Public API Key
        const SUPABASE_URL = 'https://uachxufoteeegiyzsgol.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhY2h4dWZvdGVlZWdpeXpzZ29sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0OTA2NTIsImV4cCI6MjA3MzA2NjY1Mn0.40dJrJglIUPSy2ksWL51MuJ5EU69zhTBVYt-bvV0f78';

        // Globals
        let supabase;
        let userId;
        let orders = [];
        let menuItems = [];

        // Modal helpers
        function showModal(title, message, onConfirm = () => {}) {
            const modal = document.getElementById('modal');
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalMessage').innerText = message;
            const confirmBtn = document.getElementById('modalConfirmBtn');
            const inputField = document.getElementById('modalInput');
            inputField.classList.add('hidden');
            confirmBtn.onclick = () => {
                modal.classList.add('hidden');
                onConfirm();
            };
            modal.classList.remove('hidden');
        }

        function promptWithModal(title, message, initialValue = '', onConfirm = () => {}) {
            const modal = document.getElementById('modal');
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalMessage').innerText = message;
            const confirmBtn = document.getElementById('modalConfirmBtn');
            const inputField = document.getElementById('modalInput');
            inputField.value = initialValue;
            inputField.classList.remove('hidden');
            confirmBtn.onclick = () => {
                modal.classList.add('hidden');
                onConfirm(inputField.value);
            };
            modal.classList.remove('hidden');
        }

        // DOM refs (script at end of body so elements exist)
        const orderFormSection = document.getElementById('orderFormSection');
        const ordersListSection = document.getElementById('ordersListSection');
        const manageMenuSection = document.getElementById('manageMenuSection');
        const salesReportSection = document.getElementById('salesReportSection');

        const showOrderFormBtn = document.getElementById('showOrderFormBtn');
        const showOrdersBtn = document.getElementById('showOrdersBtn');
        const showMenusBtn = document.getElementById('showMenusBtn');
        const showSalesReportBtn = document.getElementById('showSalesReportBtn');

        const orderForm = document.getElementById('orderForm');
        const menuItemsContainer = document.getElementById('menuItems');
        const menuLoadingText = document.getElementById('menu-loading-text');
        const totalPriceEl = document.getElementById('totalPrice');

        const ordersTableBody = document.querySelector('#ordersTable tbody');
        const ordersLoadingText = document.getElementById('orders-loading-text');
        const menuForm = document.getElementById('menuForm');
        const menuListContainer = document.getElementById('menuList');
        const menuManageLoadingText = document.getElementById('menu-manage-loading-text');
        const totalSalesEl = document.getElementById('totalSales');
        const topSellingItemsList = document.getElementById('topSellingItemsList');
        const reportPeriodSelect = document.getElementById('reportPeriodSelect');
        const userIdDisplay = document.getElementById('user-id-display');

        // Render & utility functions
        function renderMenuItems() {
            menuItemsContainer.innerHTML = '';
            if (!menuItems || menuItems.length === 0) {
                menuItemsContainer.innerHTML = `<p class="text-gray-500 text-center">No menu items found. Add some in the "Manage Menus" section.</p>`;
            } else {
                menuItems.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.classList.add('flex', 'items-center', 'justify-between', 'bg-gray-100', 'p-3', 'rounded-lg');
                    itemDiv.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" id="menuItem-${item.id}" data-price="${item.price}" class="menu-item-checkbox form-checkbox h-5 w-5 text-orange-600 rounded focus:ring-0">
                            <label for="menuItem-${item.id}" class="text-gray-800 font-medium">${item.name}</label>
                        </div>
                        <span class="text-gray-600">RM ${Number(item.price).toFixed(2)}</span>
                    `;
                    menuItemsContainer.appendChild(itemDiv);
                });
            }
            document.querySelectorAll('.menu-item-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', calculateTotalPrice);
            });
            menuLoadingText.classList.add('hidden');
        }

        function calculateTotalPrice() {
            let total = 0;
            document.querySelectorAll('.menu-item-checkbox:checked').forEach(checkbox => {
                total += parseFloat(checkbox.dataset.price || 0);
            });
            totalPriceEl.textContent = `RM ${total.toFixed(2)}`;
        }

        function renderOrdersList() {
            ordersTableBody.innerHTML = '';
            if (!orders || orders.length === 0) {
                ordersTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500">No orders found.</td></tr>`;
            } else {
                const sortedOrders = [...orders].sort((a, b) => new Date(b.date) - new Date(a.date));
                sortedOrders.forEach((order) => {
                    // handle items possibly stored as JSON string
                    const itemsArr = typeof order.items === 'string' ? JSON.parse(order.items) : order.items || [];
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="whitespace-nowrap">${order.date}</td>
                        <td>${order.customerName}</td>
                        <td>${itemsArr.map(i => i.name).join(', ')}</td>
                        <td class="font-bold">RM ${Number(order.totalPrice || 0).toFixed(2)}</td>
                        <td class="whitespace-nowrap">
                            <button data-id="${order.id}" class="delete-order-btn text-red-500 hover:text-red-700 font-medium transition-colors duration-200">Delete</button>
                        </td>
                    `;
                    ordersTableBody.appendChild(row);
                });
                // wire delete buttons (delegation would be better but keep simple)
                document.querySelectorAll('.delete-order-btn').forEach(btn => {
                    btn.addEventListener('click', () => deleteOrder(btn.getAttribute('data-id')));
                });
            }
            ordersLoadingText.classList.add('hidden');
        }

        function renderManageMenu() {
            menuListContainer.innerHTML = '';
            if (!menuItems || menuItems.length === 0) {
                menuListContainer.innerHTML = `<p class="text-gray-500 text-center">No menu items found.</p>`;
            } else {
                menuItems.forEach((item) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.classList.add('bg-gray-100', 'p-4', 'rounded-lg', 'flex', 'flex-col', 'sm:flex-row', 'items-center', 'justify-between', 'space-y-2', 'sm:space-y-0');
                    itemDiv.innerHTML = `
                        <span class="font-medium text-gray-800">${item.name}</span>
                        <span class="text-gray-600">RM ${Number(item.price).toFixed(2)}</span>
                        <div class="flex space-x-2">
                            <button data-id="${item.id}" data-name="${item.name}" class="edit-menu-btn px-3 py-1 bg-orange-200 text-orange-700 rounded-full text-sm hover:bg-orange-300">Edit</button>
                            <button data-id="${item.id}" class="delete-menu-btn px-3 py-1 bg-red-200 text-red-700 rounded-full text-sm hover:bg-red-300">Delete</button>
                        </div>
                    `;
                    menuListContainer.appendChild(itemDiv);
                });
                // wire up edit/delete buttons
                document.querySelectorAll('.edit-menu-btn').forEach(btn => {
                    btn.addEventListener('click', () => editMenuItem(btn.getAttribute('data-id'), btn.getAttribute('data-name')));
                });
                document.querySelectorAll('.delete-menu-btn').forEach(btn => {
                    btn.addEventListener('click', () => deleteMenuItem(btn.getAttribute('data-id')));
                });
            }
            menuManageLoadingText.classList.add('hidden');
        }

        function generateSalesReport(period) {
            const today = new Date();
            const startOfPeriod = new Date();
            if (period === 'thisWeek') {
                startOfPeriod.setDate(today.getDate() - today.getDay());
            } else if (period === 'thisMonth') {
                startOfPeriod.setDate(1);
            } else { // today
                startOfPeriod.setHours(0,0,0,0);
            }
            startOfPeriod.setHours(0,0,0,0);

            let totalSales = 0;
            const itemSales = {};
            orders.forEach(order => {
                const orderDate = new Date(order.date);
                if (orderDate >= startOfPeriod) {
                    totalSales += Number(order.totalPrice || 0);
                    const itemsArr = typeof order.items === 'string' ? JSON.parse(order.items) : order.items || [];
                    itemsArr.forEach(item => {
                        itemSales[item.name] = (itemSales[item.name] || 0) + 1;
                    });
                }
            });
            totalSalesEl.textContent = `RM ${totalSales.toFixed(2)}`;
            const sortedItems = Object.entries(itemSales).sort(([,a],[,b]) => b - a);
            topSellingItemsList.innerHTML = '';
            if (sortedItems.length === 0) {
                topSellingItemsList.innerHTML = '<li class="text-gray-500">No sales for this period.</li>';
            } else {
                sortedItems.forEach(([name, count]) => {
                    const li = document.createElement('li');
                    li.classList.add('bg-gray-100','p-2','rounded-lg');
                    li.innerHTML = `<span class="font-medium">${name}</span> - ${count} sold`;
                    topSellingItemsList.appendChild(li);
                });
            }
        }

        function sortTable(column) {
            const isAscending = ordersTableBody.getAttribute('data-sort-order') !== 'asc';
            ordersTableBody.setAttribute('data-sort-order', isAscending ? 'asc' : 'desc');
            const sortedOrders = [...orders].sort((a, b) => {
                let valA = a[column];
                let valB = b[column];
                if (column === 'date') {
                    valA = new Date(a.date);
                    valB = new Date(b.date);
                }
                if (valA < valB) return isAscending ? -1 : 1;
                if (valA > valB) return isAscending ? 1 : -1;
                return 0;
            });
            orders = sortedOrders;
            renderOrdersList();
        }

        // Form handlers
        orderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const customerName = document.getElementById('customerName').value;
            const orderDate = document.getElementById('orderDate').value;
            const selectedItems = Array.from(document.querySelectorAll('.menu-item-checkbox:checked')).map(checkbox => {
                const id = checkbox.id.split('-')[1];
                const item = menuItems.find(mi => String(mi.id) === String(id));
                return { name: item ? item.name : 'Unknown', price: Number(item ? item.price : 0) };
            });
            const totalPrice = selectedItems.reduce((s, it) => s + Number(it.price || 0), 0);
            if (selectedItems.length === 0) {
                showModal('Error', 'Please select at least one menu item.');
                return;
            }
            const newOrder = {
                customerName,
                date: orderDate,
                items: JSON.stringify(selectedItems),
                totalPrice,
                user_id: userId
            };
            try {
                const { error } = await supabase.from('orders').insert([newOrder]);
                if (error) throw error;
                showModal('Order Placed!', 'Your order has been successfully placed.');
                orderForm.reset();
                calculateTotalPrice();
            } catch (err) {
                showModal('Error', 'Error adding order: ' + (err.message || err));
                console.error('Error adding order:', err);
            }
        });

        menuForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const menuName = document.getElementById('menuName').value;
            const menuPrice = parseFloat(document.getElementById('menuPrice').value || 0);
            const newItem = { name: menuName, price: menuPrice, user_id: userId };
            try {
                const { error } = await supabase.from('menus').insert([newItem]);
                if (error) throw error;
                showModal('Menu Item Added!', `${newItem.name} has been added to the menu.`);
                menuForm.reset();
            } catch (err) {
                showModal('Error', 'Error adding menu item: ' + (err.message || err));
                console.error('Error adding menu item:', err);
            }
        });

        // CRUD helpers
        async function deleteOrder(id) {
            showModal('Confirm Delete', 'Are you sure you want to delete this order?', async () => {
                try {
                    const { error } = await supabase.from('orders').delete().eq('id', id);
                    if (error) throw error;
                } catch (err) {
                    showModal('Error', 'Error deleting order: ' + (err.message || err));
                    console.error('Error deleting order:', err);
                }
            });
        }

        function editMenuItem(id, currentName) {
            promptWithModal('Edit Menu Item', `Enter new name for "${currentName}":`, currentName, async (newName) => {
                if (!newName) return;
                try {
                    const { error } = await supabase.from('menus').update({ name: newName }).eq('id', id);
                    if (error) throw error;
                } catch (err) {
                    showModal('Error', 'Error updating menu item: ' + (err.message || err));
                    console.error('Error updating menu item:', err);
                }
            });
        }

        async function deleteMenuItem(id) {
            showModal('Confirm Delete', 'Are you sure you want to delete this menu item?', async () => {
                try {
                    const { error } = await supabase.from('menus').delete().eq('id', id);
                    if (error) throw error;
                } catch (err) {
                    showModal('Error', 'Error deleting menu item: ' + (err.message || err));
                    console.error('Error deleting menu item:', err);
                }
            });
        }

        // Active button helper
        function setActiveButton(activeBtn) {
            const buttons = [showOrderFormBtn, showOrdersBtn, showMenusBtn, showSalesReportBtn];
            buttons.forEach(btn => {
                btn.classList.remove('btn-active');
                btn.classList.add('btn-secondary');
            });
            if (activeBtn) {
                activeBtn.classList.remove('btn-secondary');
                activeBtn.classList.add('btn-active');
            }
        }

        // Navigation wiring
        showOrderFormBtn.addEventListener('click', () => {
            ordersListSection.classList.add('hidden');
            manageMenuSection.classList.add('hidden');
            salesReportSection.classList.add('hidden');
            orderFormSection.classList.remove('hidden');
            setActiveButton(showOrderFormBtn);
        });

        showMenusBtn.addEventListener('click', () => {
            ordersListSection.classList.add('hidden');
            orderFormSection.classList.add('hidden');
            salesReportSection.classList.add('hidden');
            manageMenuSection.classList.remove('hidden');
            setActiveButton(showMenusBtn);
        });

        showOrdersBtn.addEventListener('click', () => {
            orderFormSection.classList.add('hidden');
            manageMenuSection.classList.add('hidden');
            salesReportSection.classList.add('hidden');
            ordersListSection.classList.remove('hidden');
            setActiveButton(showOrdersBtn);
        });

        showSalesReportBtn.addEventListener('click', () => {
            orderFormSection.classList.add('hidden');
            manageMenuSection.classList.add('hidden');
            ordersListSection.classList.add('hidden');
            salesReportSection.classList.remove('hidden');
            generateSalesReport(reportPeriodSelect.value);
            setActiveButton(showSalesReportBtn);
        });

        reportPeriodSelect.addEventListener('change', (e) => generateSalesReport(e.target.value));

        // --- INITIALIZATION FUNCTION (must be defined before window.onload) ---
        const initializeSupabase = async () => {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase client created successfully.');

                // Use a random user ID for demo
                // userId = crypto.randomUUID();
				userId = 'Ashikin';
                userIdDisplay.textContent = `User ID: ${userId}`;

                // Realtime: orders
                supabase.channel('orders-changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, payload => {
                        // payload.eventType may be 'INSERT'|'UPDATE'|'DELETE'
                        if (payload.eventType === 'INSERT' || payload.event === 'INSERT') {
                            orders.push(payload.new);
                        } else if (payload.eventType === 'UPDATE' || payload.event === 'UPDATE') {
                            const idx = orders.findIndex(o => o.id === payload.new.id);
                            if (idx !== -1) orders[idx] = payload.new;
                        } else if (payload.eventType === 'DELETE' || payload.event === 'DELETE') {
                            orders = orders.filter(o => o.id !== payload.old.id);
                        }
                        renderOrdersList();
                        generateSalesReport(reportPeriodSelect.value);
                    })
                    .subscribe();

                // Realtime: menus
                supabase.channel('menus-changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'menus' }, payload => {
                        if (payload.eventType === 'INSERT' || payload.event === 'INSERT') {
                            menuItems.push(payload.new);
                        } else if (payload.eventType === 'UPDATE' || payload.event === 'UPDATE') {
                            const index = menuItems.findIndex(m => m.id === payload.new.id);
                            if (index !== -1) menuItems[index] = payload.new;
                        } else if (payload.eventType === 'DELETE' || payload.event === 'DELETE') {
                            menuItems = menuItems.filter(m => m.id !== payload.old.id);
                        }
                        renderMenuItems();
                        renderManageMenu();
                    })
                    .subscribe();

                // Initial fetch orders
                const { data: initialOrders, error: ordersError } = await supabase.from('orders').select('*').order('date', { ascending: false });
                if (ordersError) throw ordersError;
                orders = initialOrders || [];
                renderOrdersList();

                // Initial fetch menus
                const { data: initialMenus, error: menusError } = await supabase.from('menus').select('*');
                if (menusError) throw menusError;
                menuItems = initialMenus || [];
                renderMenuItems();
                renderManageMenu();

                // Generate initial sales report
                generateSalesReport(reportPeriodSelect.value);

            } catch (error) {
                console.error('Supabase Initialization Error:', error);
                showModal('Initialization Error', `Failed to initialize Supabase: ${error.message || error}`);
            }
        };

        // Safe public exports for inline handlers (some code used inline onclicks)
        window.sortTable = sortTable;
        window.deleteOrder = deleteOrder;
        window.editMenuItem = editMenuItem;
        window.deleteMenuItem = deleteMenuItem;

        // Run on load
        window.addEventListener('load', () => {
            initializeSupabase();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('orderDate').value = today;
            calculateTotalPrice();
            setActiveButton(showOrderFormBtn); // default active
        });
    </script>
</body>
</html>
