<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Order System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            transition: all 0.3s ease;
        }
        .container {
            max-width: 90%;
            margin: 0 auto;
            padding: 2rem 1rem;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2.5rem;
            margin-bottom: 2rem;
        }
        .input-group label {
            font-weight: 500;
            color: #4b5563;
        }
        .input-group input, .input-group select, .input-group textarea {
            margin-top: 0.5rem;
            border-radius: 0.75rem;
            border: 1px solid #d1d5db;
            padding: 0.75rem 1rem;
            width: 100%;
            font-size: 1rem;
            color: #1f2937;
            transition: all 0.2s ease-in-out;
        }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .btn-primary {
            background-color: #6366f1;
            color: white;
            padding: 1rem 2rem;
            border-radius: 1rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #4f46e5;
            box-shadow: 0 4px 6px rgba(99, 102, 241, 0.3);
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #4b5563;
            padding: 1rem 2rem;
            border-radius: 1rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4b5563;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .message-box.show {
            transform: translateX(0);
        }
        .table-container {
            overflow-x: auto;
        }
        th, td {
            padding: 1rem;
            white-space: nowrap;
        }
        th {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        th:hover::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: -5px;
            height: 2px;
            background-color: #6366f1;
            transition: width 0.3s ease-in-out;
            width: 100%;
        }
        .sort-icon {
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5rem;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            opacity: 0.5;
        }
        .sort-asc .sort-icon {
            border-bottom: 5px solid #000;
            opacity: 1;
        }
        .sort-desc .sort-icon {
            border-top: 5px solid #000;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 antialiased text-gray-800">

    <!-- Message Box for alerts -->
    <div id="messageBox" class="message-box"></div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-indigo-700">Food Order System</h1>
            <p id="userIdDisplay" class="text-sm mt-2 font-medium text-gray-500">User ID: Loading...</p>
            <div class="mt-4 flex justify-center space-x-4">
                <button id="showOrderFormBtn" class="btn-primary">Place Order</button>
                <button id="showMenusBtn" class="btn-primary">Manage Menu</button>
                <button id="showOrdersBtn" class="btn-primary">View All Orders</button>
                <button id="showSalesReportBtn" class="btn-primary">View Sales Report</button>
            </div>
        </header>

        <!-- Order Form Section -->
        <div id="orderFormSection" class="card">
            <h2 class="text-2xl font-bold mb-6 text-gray-700">Place a New Order</h2>
            <form id="orderForm" class="space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div class="input-group">
                        <label for="ordererName" class="block">Your Name</label>
                        <input type="text" id="ordererName" placeholder="John Doe" required>
                    </div>
                    <div class="input-group">
                        <label for="location" class="block">Your Location</label>
                        <input type="text" id="location" placeholder="Office, Home, etc." required>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div class="input-group">
                        <label for="menuSelect" class="block">Menu Item</label>
                        <select id="menuSelect" required>
                            <option value="" disabled selected>Select a menu item</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="price" class="block">Price (RM)</label>
                        <input type="number" id="price" placeholder="0.00" step="0.01" min="0" required readonly>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div class="input-group">
                        <label for="count" class="block">Quantity</label>
                        <input type="number" id="count" value="1" min="1" required>
                    </div>
                    <div class="input-group">
                        <label for="orderDate" class="block">Order Date</label>
                        <input type="date" id="orderDate" required>
                    </div>
                </div>

                <div class="bg-indigo-50 border border-indigo-200 text-indigo-800 p-4 rounded-xl flex justify-between items-center font-bold">
                    <span>Total Price:</span>
                    <span id="totalPrice" class="text-xl">RM 0.00</span>
                </div>

                <button type="submit" class="btn-primary w-full text-center">Place Order</button>
            </form>
        </div>

        <!-- Orders List Section -->
        <div id="ordersListSection" class="card hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-700">All Orders</h2>
            
            <div class="mb-4">
                 <button id="summarizeOrdersBtn" class="btn-primary">âœ¨ Summarize Orders</button>
            </div>

            <div id="summaryContainer" class="hidden bg-gray-100 p-4 rounded-xl mb-4">
                <p id="summaryText" class="text-gray-800 text-sm italic"></p>
                <div id="summaryLoading" class="hidden text-center text-gray-500">Generating summary...</div>
            </div>

            <div class="table-container bg-white p-4 rounded-xl">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr>
                            <th class="border-b border-gray-200 text-gray-600 font-semibold text-sm uppercase tracking-wider" onclick="sortTable('name')">Name<span class="sort-icon"></span></th>
                            <th class="border-b border-gray-200 text-gray-600 font-semibold text-sm uppercase tracking-wider">Location</th>
                            <th class="border-b border-gray-200 text-gray-600 font-semibold text-sm uppercase tracking-wider" onclick="sortTable('date')">Date<span class="sort-icon"></span></th>
                            <th class="border-b border-gray-200 text-gray-600 font-semibold text-sm uppercase tracking-wider">Menu</th>
                            <th class="border-b border-gray-200 text-gray-600 font-semibold text-sm uppercase tracking-wider">Qty</th>
                            <th class="border-b border-gray-200 text-gray-600 font-semibold text-sm uppercase tracking-wider">Price (RM)</th>
                            <th class="border-b border-gray-200 text-gray-600 font-semibold text-sm uppercase tracking-wider">Total (RM)</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody" class="text-gray-700">
                        <!-- Orders will be injected here -->
                    </tbody>
                </table>
                <div id="noOrdersMessage" class="text-center text-gray-500 py-8 text-lg hidden">No orders yet. Be the first to place one!</div>
            </div>
        </div>

        <!-- Manage Menu Section -->
        <div id="manageMenuSection" class="card hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-700">Manage Menu Items</h2>
            <form id="menuForm" class="space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div class="input-group">
                        <label for="newMenuItem" class="block">New Menu Item</label>
                        <input type="text" id="newMenuItem" placeholder="e.g., Nasi Lemak" required>
                    </div>
                    <div class="input-group">
                        <label for="newMenuPrice" class="block">Price (RM)</label>
                        <input type="number" id="newMenuPrice" placeholder="e.g., 7.50" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="input-group">
                    <label for="menuDescription" class="block flex justify-between items-center">
                        <span>Menu Description</span>
                        <button type="button" id="generateDescriptionBtn" class="btn-secondary px-4 py-2 text-sm">âœ¨ Generate Description</button>
                    </label>
                    <textarea id="menuDescription" rows="2" placeholder="A rich, savory coconut milk rice served with..."></textarea>
                </div>
                <button type="submit" class="btn-primary w-full text-center">Add Menu Item</button>
            </form>

            <div class="mt-8">
                <h3 class="text-xl font-bold mb-4 text-gray-700">Current Menu</h3>
                <div class="table-container bg-white p-4 rounded-xl">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr>
                                <th class="border-b border-gray-200 text-gray-600 font-semibold text-sm uppercase tracking-wider">Menu Item</th>
                                <th class="border-b border-gray-200 text-gray-600 font-semibold text-sm uppercase tracking-wider">Description</th>
                                <th class="border-b border-gray-200 text-gray-600 font-semibold text-sm uppercase tracking-wider">Price (RM)</th>
                                <th class="border-b border-gray-200 text-gray-600 font-semibold text-sm uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="menuTableBody" class="text-gray-700">
                            <!-- Menu items will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sales Report Section -->
        <div id="salesReportSection" class="card hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-700">Sales Report</h2>
            <div class="flex items-center space-x-4 mb-4">
                <label for="reportPeriod" class="text-gray-700 font-medium">View By:</label>
                <select id="reportPeriod" class="btn-secondary px-4 py-2 rounded-xl">
                    <option value="monthly">Monthly</option>
                    <option value="weekly">Weekly</option>
                    <option value="yearly">Yearly</option>
                </select>
            </div>
            <div id="reportContent" class="space-y-6">
                <div id="noSalesDataMessage" class="text-center text-gray-500 py-8 text-lg hidden">No sales data available for this period.</div>
                <!-- Sales data will be injected here -->
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, setLogLevel, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Use the global variables for Firebase configuration
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId;
        let allOrders = [];
        let availableMenus = [];
        let currentSortColumn = null;
        let currentSortDirection = 'asc';
        
        setLogLevel('debug');

        // Get DOM elements
        const orderForm = document.getElementById('orderForm');
        const countInput = document.getElementById('count');
        const priceInput = document.getElementById('price');
        const menuSelect = document.getElementById('menuSelect');
        const totalPriceSpan = document.getElementById('totalPrice');
        const ordersTableBody = document.getElementById('ordersTableBody');
        const orderFormSection = document.getElementById('orderFormSection');
        const ordersListSection = document.getElementById('ordersListSection');
        const manageMenuSection = document.getElementById('manageMenuSection');
        const salesReportSection = document.getElementById('salesReportSection');
        const showOrderFormBtn = document.getElementById('showOrderFormBtn');
        const showMenusBtn = document.getElementById('showMenusBtn');
        const showOrdersBtn = document.getElementById('showOrdersBtn');
        const showSalesReportBtn = document.getElementById('showSalesReportBtn');
        const noOrdersMessage = document.getElementById('noOrdersMessage');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const messageBox = document.getElementById('messageBox');
        
        // Merchant Menu elements
        const menuForm = document.getElementById('menuForm');
        const newMenuItemInput = document.getElementById('newMenuItem');
        const newMenuPriceInput = document.getElementById('newMenuPrice');
        const menuDescriptionInput = document.getElementById('menuDescription');
        const menuTableBody = document.getElementById('menuTableBody');
        const generateDescriptionBtn = document.getElementById('generateDescriptionBtn');
        const summarizeOrdersBtn = document.getElementById('summarizeOrdersBtn');
        const summaryContainer = document.getElementById('summaryContainer');
        const summaryText = document.getElementById('summaryText');
        const summaryLoading = document.getElementById('summaryLoading');
        
        // Sales Report elements
        const reportPeriodSelect = document.getElementById('reportPeriod');
        const reportContentDiv = document.getElementById('reportContent');
        const noSalesDataMessage = document.getElementById('noSalesDataMessage');

        //--- AUTHENTICATION AND INITIALIZATION ---
        function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                authenticateUser();
            } catch (error) {
                console.error("Firebase initialization error:", error);
                showMessage("Failed to initialize app. Please check your config.", "error");
            }
        }

        async function authenticateUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser.uid;
                userIdDisplay.textContent = `User ID: ${userId}`;
                console.log("Firebase authenticated successfully. User ID:", userId);
                setupRealtimeListeners();
            } catch (error) {
                console.error("Authentication error:", error);
                showMessage("Authentication failed. Cannot access database.", "error");
            }
        }

        function showMessage(message, type = "info") {
            messageBox.textContent = message;
            messageBox.style.backgroundColor = type === "error" ? "#dc2626" : "#4b5563";
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        function calculateTotalPrice() {
            const count = parseFloat(countInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const total = count * price;
            totalPriceSpan.textContent = `RM ${total.toFixed(2)}`;
        }

        function renderOrders(ordersToRender) {
            ordersTableBody.innerHTML = '';
            if (ordersToRender.length === 0) {
                noOrdersMessage.classList.remove('hidden');
                return;
            } else {
                noOrdersMessage.classList.add('hidden');
            }

            ordersToRender.forEach(order => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100 last:border-b-0 hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="p-4 rounded-l-xl">${order.name}</td>
                    <td class="p-4">${order.location}</td>
                    <td class="p-4">${order.date}</td>
                    <td class="p-4 font-medium text-gray-900">${order.menu}</td>
                    <td class="p-4">${order.count}</td>
                    <td class="p-4">RM ${order.price.toFixed(2)}</td>
                    <td class="p-4 rounded-r-xl font-bold text-green-600">RM ${order.totalPrice.toFixed(2)}</td>
                `;
                ordersTableBody.appendChild(row);
            });
        }
        
        function renderMenus() {
            menuSelect.innerHTML = '<option value="" disabled selected>Select a menu item</option>';
            menuTableBody.innerHTML = '';
            
            availableMenus.forEach(menu => {
                // Populate the select dropdown
                const option = document.createElement('option');
                option.value = JSON.stringify({ item: menu.item, price: menu.price });
                option.textContent = menu.item;
                menuSelect.appendChild(option);
                
                // Populate the merchant menu table
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100 last:border-b-0 hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="p-4 font-medium text-gray-900 rounded-l-xl" contenteditable="true" data-field="item">${menu.item}</td>
                    <td class="p-4 text-gray-600" contenteditable="true" data-field="description">${menu.description || 'N/A'}</td>
                    <td class="p-4" contenteditable="true" data-field="price">RM ${menu.price.toFixed(2)}</td>
                    <td class="p-4 rounded-r-xl">
                        <button class="update-btn bg-indigo-500 text-white text-sm px-3 py-1 rounded-full hover:bg-indigo-600 transition-colors mr-2" data-id="${menu.id}">Update</button>
                        <button class="delete-btn bg-red-500 text-white text-sm px-3 py-1 rounded-full hover:bg-red-600 transition-colors" data-id="${menu.id}">Delete</button>
                    </td>
                `;
                menuTableBody.appendChild(row);
            });
        }

        //--- FIREBASE LOGIC ---
        async function saveOrder(order) {
            try {
                const ordersRef = collection(db, `artifacts/${appId}/public/data/orders`);
                await addDoc(ordersRef, {
                    ...order,
                    createdAt: new Date().toISOString()
                });
                showMessage("Order placed successfully!", "success");
                orderForm.reset();
                calculateTotalPrice();
                showOrdersBtn.click();
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Error placing order. Please try again.", "error");
            }
        }
        
        async function saveMenuItem(menuItem) {
            try {
                const menusRef = collection(db, `artifacts/${appId}/public/data/menus`);
                await addDoc(menusRef, menuItem);
                showMessage("Menu item added successfully!", "success");
                menuForm.reset();
            } catch (e) {
                console.error("Error adding menu item: ", e);
                showMessage("Error adding menu item. Please try again.", "error");
            }
        }
        
        async function updateMenuItem(id, data) {
            try {
                const menuDocRef = doc(db, `artifacts/${appId}/public/data/menus`, id);
                await updateDoc(menuDocRef, data);
                showMessage("Menu item updated successfully!", "success");
            } catch (e) {
                console.error("Error updating menu item:", e);
                showMessage("Error updating menu item.", "error");
            }
        }

        async function deleteMenuItem(id) {
            try {
                const menuDocRef = doc(db, `artifacts/${appId}/public/data/menus`, id);
                await deleteDoc(menuDocRef);
                showMessage("Menu item deleted successfully!", "success");
            } catch (e) {
                console.error("Error deleting menu item:", e);
                showMessage("Error deleting menu item.", "error");
            }
        }
        
        function setupRealtimeListeners() {
            if (!db || !userId) {
                console.log("Database or user not ready. Skipping listener setup.");
                return;
            }
            
            // Listener for orders
            const ordersRef = collection(db, `artifacts/${appId}/public/data/orders`);
            const ordersQuery = query(ordersRef);

            onSnapshot(ordersQuery, (snapshot) => {
                const updatedOrders = [];
                snapshot.forEach((doc) => {
                    updatedOrders.push(doc.data());
                });
                allOrders = updatedOrders;
                sortTable(currentSortColumn);
            }, (error) => {
                console.error("Error listening for orders:", error);
                showMessage("Error fetching orders. Please check your connection.", "error");
            });
            
            // Listener for menus
            const menusRef = collection(db, `artifacts/${appId}/public/data/menus`);
            const menusQuery = query(menusRef);
            
            onSnapshot(menusQuery, (snapshot) => {
                const updatedMenus = [];
                snapshot.forEach((doc) => {
                    updatedMenus.push({ id: doc.id, ...doc.data() });
                });
                availableMenus = updatedMenus;
                renderMenus();
            }, (error) => {
                console.error("Error listening for menus:", error);
                showMessage("Error fetching menus. Please check your connection.", "error");
            });
        }

        function sortTable(columnName) {
            if (currentSortColumn === columnName) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = columnName;
                currentSortDirection = 'asc';
            }

            const sortedOrders = [...allOrders].sort((a, b) => {
                const aValue = a[columnName];
                const bValue = b[columnName];

                if (aValue < bValue) return currentSortDirection === 'asc' ? -1 : 1;
                if (aValue > bValue) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // Update sort icons
            document.querySelectorAll('th span.sort-icon').forEach(icon => {
                icon.parentElement.classList.remove('sort-asc', 'sort-desc');
            });

            if (columnName) {
                const currentHeader = document.querySelector(`th[onclick="sortTable('${columnName}')"]`);
                if (currentHeader) {
                    currentHeader.classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            }
            renderOrders(sortedOrders);
        }

        //--- GEMINI API FUNCTIONS ---
        async function generateDescription(item) {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const prompt = `Write a short, appetizing, and creative food description (max 20 words) for the dish: "${item}". Do not include the dish name in the response.`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };

            let retryCount = 0;
            const maxRetries = 3;
            
            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) {
                            const delay = Math.pow(2, retryCount) * 1000;
                            console.warn(`Rate limit exceeded. Retrying in ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            retryCount++;
                            continue;
                        } else {
                            throw new Error(`API error: ${response.statusText}`);
                        }
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    return text || 'A delicious, irresistible dish for any occasion.';

                } catch (error) {
                    console.error("Error generating description:", error);
                    return 'A delicious, irresistible dish for any occasion.';
                }
            }
            return 'A delicious, irresistible dish for any occasion.';
        }
        
        async function summarizeOrders() {
            if (allOrders.length === 0) {
                summaryContainer.classList.remove('hidden');
                summaryText.textContent = "No orders to summarize yet.";
                return;
            }

            summaryContainer.classList.remove('hidden');
            summaryLoading.classList.remove('hidden');
            summaryText.classList.add('hidden');
            
            const ordersString = allOrders.map(order => 
                `Item: ${order.menu}, Qty: ${order.count}, Price: RM${order.price.toFixed(2)}`
            ).join('; ');

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const prompt = `Based on the following food orders, provide a concise summary (max 3 sentences). Mention the most popular item(s), total quantity of all items, and total revenue. Orders: ${ordersString}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            
            let retryCount = 0;
            const maxRetries = 3;

            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) {
                            const delay = Math.pow(2, retryCount) * 1000;
                            console.warn(`Rate limit exceeded. Retrying in ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            retryCount++;
                            continue;
                        } else {
                            throw new Error(`API error: ${response.statusText}`);
                        }
                    }

                    const result = await response.json();
                    const summary = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    summaryText.textContent = summary || "Could not generate a summary.";
                    summaryText.classList.remove('hidden');
                    summaryLoading.classList.add('hidden');
                    return;

                } catch (error) {
                    console.error("Error summarizing orders:", error);
                    summaryText.textContent = "Error generating summary. Please try again.";
                    summaryText.classList.remove('hidden');
                    summaryLoading.classList.add('hidden');
                    return;
                }
            }
        }
        
        //--- SALES REPORT LOGIC ---
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }

        function generateSalesReport(period) {
            reportContentDiv.innerHTML = '';
            noSalesDataMessage.classList.add('hidden');

            if (allOrders.length === 0) {
                noSalesDataMessage.classList.remove('hidden');
                return;
            }

            const salesData = {};

            allOrders.forEach(order => {
                const orderDate = new Date(order.date);
                let periodKey;

                if (period === 'monthly') {
                    periodKey = `${orderDate.getFullYear()}-${(orderDate.getMonth() + 1).toString().padStart(2, '0')}`;
                } else if (period === 'weekly') { // weekly
                    const weekNo = getWeekNumber(orderDate);
                    periodKey = `${orderDate.getFullYear()}-W${weekNo.toString().padStart(2, '0')}`;
                } else { // yearly
                    periodKey = orderDate.getFullYear().toString();
                }

                if (!salesData[periodKey]) {
                    salesData[periodKey] = {};
                }

                if (!salesData[periodKey][order.menu]) {
                    salesData[periodKey][order.menu] = {
                        item: order.menu,
                        totalQuantity: 0,
                        totalRevenue: 0,
                    };
                }

                salesData[periodKey][order.menu].totalQuantity += order.count;
                salesData[periodKey][order.menu].totalRevenue += order.totalPrice;
            });

            // Sort the periods chronologically
            const sortedPeriods = Object.keys(salesData).sort();

            if (sortedPeriods.length === 0) {
                noSalesDataMessage.classList.remove('hidden');
                return;
            }

            sortedPeriods.forEach(periodKey => {
                const periodDiv = document.createElement('div');
                periodDiv.className = 'bg-white p-4 rounded-xl shadow-inner';

                const periodTitle = document.createElement('h3');
                periodTitle.className = 'text-xl font-bold mb-4 text-gray-700';
                if (period === 'monthly') {
                    const [year, month] = periodKey.split('-');
                    const monthName = new Date(year, month - 1).toLocaleString('default', { month: 'long' });
                    periodTitle.textContent = `${monthName} ${year} Sales`;
                } else if (period === 'weekly') {
                    periodTitle.textContent = `Sales for Week ${periodKey.split('-')[1]} of ${periodKey.split('-')[0]}`;
                } else { // yearly
                    periodTitle.textContent = `Sales for Year ${periodKey}`;
                }
                periodDiv.appendChild(periodTitle);

                const tableContainer = document.createElement('div');
                tableContainer.className = 'table-container';

                const table = document.createElement('table');
                table.className = 'w-full text-left border-collapse';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th class="border-b border-gray-200 text-gray-600 font-semibold text-sm uppercase tracking-wider">Rank</th>
                            <th class="border-b border-gray-200 text-gray-600 font-semibold text-sm uppercase tracking-wider">Menu Item</th>
                            <th class="border-b border-gray-200 text-gray-600 font-semibold text-sm uppercase tracking-wider">Total Quantity</th>
                            <th class="border-b border-gray-200 text-gray-600 font-semibold text-sm uppercase tracking-wider">Total Revenue (RM)</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700"></tbody>
                `;

                const tbody = table.querySelector('tbody');
                const rankedItems = Object.values(salesData[periodKey]).sort((a, b) => b.totalRevenue - a.totalRevenue);

                rankedItems.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-100 last:border-b-0 hover:bg-gray-50 transition-colors';
                    row.innerHTML = `
                        <td class="p-4">${index + 1}</td>
                        <td class="p-4 font-medium text-gray-900">${item.item}</td>
                        <td class="p-4">${item.totalQuantity}</td>
                        <td class="p-4 font-bold text-green-600">RM ${item.totalRevenue.toFixed(2)}</td>
                    `;
                    tbody.appendChild(row);
                });

                tableContainer.appendChild(table);
                periodDiv.appendChild(tableContainer);
                reportContentDiv.appendChild(periodDiv);
            });
        }


        //--- EVENT LISTENERS ---
        orderForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const ordererName = document.getElementById('ordererName').value.trim();
            const location = document.getElementById('location').value.trim();
            const selectedMenu = JSON.parse(menuSelect.value);
            const count = parseInt(document.getElementById('count').value, 10);
            const orderDate = document.getElementById('orderDate').value;
            
            if (!ordererName || !location || !selectedMenu.item || isNaN(count) || !orderDate) {
                showMessage("Please fill out all fields correctly.", "error");
                return;
            }

            const newOrder = {
                name: ordererName,
                location: location,
                date: orderDate,
                menu: selectedMenu.item,
                price: selectedMenu.price,
                count: count,
                totalPrice: selectedMenu.price * count,
            };
            saveOrder(newOrder);
        });

        menuSelect.addEventListener('change', () => {
            const selectedMenu = JSON.parse(menuSelect.value);
            priceInput.value = selectedMenu.price.toFixed(2);
            calculateTotalPrice();
        });

        countInput.addEventListener('input', calculateTotalPrice);
        priceInput.addEventListener('input', calculateTotalPrice);
        
        menuForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newMenuItem = newMenuItemInput.value.trim();
            const newMenuPrice = parseFloat(newMenuPriceInput.value);
            const menuDescription = menuDescriptionInput.value.trim();
            
            if (!newMenuItem || isNaN(newMenuPrice)) {
                showMessage("Please enter a valid menu item and price.", "error");
                return;
            }
            
            const newMenu = {
                item: newMenuItem,
                price: newMenuPrice,
                description: menuDescription,
            };
            
            saveMenuItem(newMenu);
        });

        generateDescriptionBtn.addEventListener('click', async () => {
            const item = newMenuItemInput.value.trim();
            if (!item) {
                showMessage("Please enter a menu item first.", "error");
                return;
            }
            menuDescriptionInput.placeholder = "Generating...";
            menuDescriptionInput.disabled = true;
            generateDescriptionBtn.disabled = true;
            const description = await generateDescription(item);
            menuDescriptionInput.value = description;
            menuDescriptionInput.placeholder = "A rich, savory coconut milk rice served with...";
            menuDescriptionInput.disabled = false;
            generateDescriptionBtn.disabled = false;
        });
        
        // Use event delegation for the menu table buttons
        menuTableBody.addEventListener('click', (e) => {
            const target = e.target;
            const id = target.getAttribute('data-id');
            const row = target.closest('tr');

            if (target.classList.contains('update-btn')) {
                const newName = row.querySelector('[data-field="item"]').textContent.trim();
                const newDesc = row.querySelector('[data-field="description"]').textContent.trim();
                const newPrice = parseFloat(row.querySelector('[data-field="price"]').textContent.replace('RM', '').trim());

                if (isNaN(newPrice) || !newName) {
                    showMessage("Invalid name or price.", "error");
                    return;
                }
                updateMenuItem(id, { item: newName, description: newDesc, price: newPrice });

            } else if (target.classList.contains('delete-btn')) {
                deleteMenuItem(id);
            }
        });


        summarizeOrdersBtn.addEventListener('click', summarizeOrders);

        reportPeriodSelect.addEventListener('change', () => {
            generateSalesReport(reportPeriodSelect.value);
        });

        showOrderFormBtn.addEventListener('click', () => {
            ordersListSection.classList.add('hidden');
            manageMenuSection.classList.add('hidden');
            salesReportSection.classList.add('hidden');
            orderFormSection.classList.remove('hidden');
            currentSortColumn = null;
            currentSortDirection = 'asc';
            document.querySelectorAll('th').forEach(th => th.className = th.className.split(' ').filter(c => !c.startsWith('sort-')).join(' '));
        });

        showMenusBtn.addEventListener('click', () => {
            ordersListSection.classList.add('hidden');
            orderFormSection.classList.add('hidden');
            salesReportSection.classList.add('hidden');
            manageMenuSection.classList.remove('hidden');
        });

        showOrdersBtn.addEventListener('click', () => {
            orderFormSection.classList.add('hidden');
            manageMenuSection.classList.add('hidden');
            salesReportSection.classList.add('hidden');
            ordersListSection.classList.remove('hidden');
            summaryContainer.classList.add('hidden');
            sortTable('date');
        });

        showSalesReportBtn.addEventListener('click', () => {
            orderFormSection.classList.add('hidden');
            manageMenuSection.classList.add('hidden');
            ordersListSection.classList.add('hidden');
            salesReportSection.classList.remove('hidden');
            generateSalesReport(reportPeriodSelect.value);
        });

        //--- INITIALIZATION ---
        window.onload = () => {
            initializeFirebase();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('orderDate').value = today;
            calculateTotalPrice();
        };

        // Make the sortTable function available globally
        window.sortTable = sortTable;

    </script>
</body>
</html>
